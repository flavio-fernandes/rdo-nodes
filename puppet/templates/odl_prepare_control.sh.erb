sudo systemctl stop neutron-server

ML2CONFFILE='/etc/neutron/plugins/ml2/ml2_conf.ini'

sudo crudini --set ${ML2CONFFILE} ml2 mechanism_drivers opendaylight 
sudo crudini --set ${ML2CONFFILE} ml2 tenant_network_types vxlan

ODL_IP='192.168.50.1'
SET_ML2ODLURL="http://${ODL_IP}:8080/controller/nb/v2/neutron"
CURR_ML2ODLURL=$(sudo crudini --get ${ML2CONFFILE} ml2_odl url 2> /dev/null)
if [ -z ${CURR_ML2ODLURL} ]; then
    sudo cp --no-clobber ${ML2CONFFILE}{,.orig}
    cat <<EOT | sudo tee -a ${ML2CONFFILE} > /dev/null

[ml2_odl]
password = admin
username = admin
url = ${SET_ML2ODLURL}

EOT

else
    if [ "${CURR_ML2ODLURL}" != "${SET_ML2ODLURL}" ]; then
        sudo cp --no-clobber ${ML2CONFFILE}{,.orig}
	sudo crudini --set ${ML2CONFFILE} ml2_odl url ${SET_ML2ODLURL}
    fi
fi

sudo mysql -e "drop database if exists neutron_ml2;"
sudo mysql -e "create database neutron_ml2 character set utf8;"
sudo mysql -e "grant all on neutron_ml2.* to 'neutron'@'%';"
sudo neutron-db-manage --config-file /usr/share/neutron/neutron-dist.conf --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugin.ini upgrade head

sudo systemctl start neutron-server

